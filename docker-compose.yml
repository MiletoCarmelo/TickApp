services:
  postgres:
    image: postgres:16-alpine
    container_name: receipt-postgres
    restart: unless-stopped
    env_file:
      - .env  # ← Doit contenir POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, POSTGRES_PORT
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    volumes:
      - receipt_pgdata:/var/lib/postgresql/data
      - ./pg/init_scripts:/docker-entrypoint-initdb.d:ro  # Scripts exécutés au 1er démarrage
      - ./backups:/backups  # Dossier pour les backups
    healthcheck:
      # Utilise les variables d'environnement définies dans le conteneur (POSTGRES_USER, POSTGRES_DB)
      test: ["CMD-SHELL", "pg_isready -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - receipt-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: receipt-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@receipt.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network

  dagster-webserver:
    build:
      context: .
      dockerfile: Dockerfile.dagster
    container_name: receipt-dagster-webserver
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - DAGSTER_CURRENT_IMAGE=receipt-dagster-webserver
    ports:
      # Le port interne de Dagster est 3000, mais on le mappe sur 3300 côté host
      - "${DAGSTER_PORT:-3300}:3000"
    volumes:
      - .:/app
      - dagster_home:/app/dagster_home
      - signal_cli_data:/root/.local/share/signal-cli
    # Avec Dagster 1.12, on utilise `dagster dev` (qui lance web UI + daemon)
    # Pas besoin de `-w` car le module est déjà défini dans pyproject.toml ([tool.dagster])
    command: ["dagster", "dev", "-h", "0.0.0.0", "-p", "3000"]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: receipt-dashboard
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${DASHBOARD_PORT:-8050}:8050"
    volumes:
      - ./dashboard:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network

volumes:
  receipt_pgdata:
    driver: local
  pgadmin_data:
    driver: local
  dagster_home:
    driver: local
  signal_cli_data:
    driver: local

networks:
  receipt-network:
    driver: bridge
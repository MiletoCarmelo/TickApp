services:
  # ============================================
  # TRAEFIK - Reverse Proxy
  # ============================================
  traefik:
    image: traefik:v3.0
    container_name: receipt-traefik
    restart: unless-stopped
    command:
      # Enable Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Enable dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"  # Dashboard accessible sans auth (réseau privé Tailscale)
      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"  # Dashboard Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Accès aux containers Docker
      - traefik_certs:/certs  # Pour stocker les certificats SSL si besoin
    networks:
      - receipt-network
    labels:
      # Dashboard Traefik accessible via traefik.home.tailc6fb0e.ts.net
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.home.tailc6fb0e.ts.net`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=web"

  # ============================================
  # POSTGRES - Base de données
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: receipt-postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5434}:5432"  # Accès direct via Tailscale (non exposé par Traefik)
    volumes:
      - receipt_pgdata:/var/lib/postgresql/data
      - ./pg/init_scripts:/docker-entrypoint-initdb.d:ro
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - receipt-network

  # ============================================
  # PGADMIN - Interface PostgreSQL
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: receipt-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@receipt.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network
    labels:
      # Accessible via pgadmin.home.tailc6fb0e.ts.net
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.home.tailc6fb0e.ts.net`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"

  # ============================================
  # DAGSTER - Orchestration
  # ============================================
  dagster-webserver:
    build:
      context: .
      dockerfile: Dockerfile.dagster
    container_name: receipt-dagster-webserver
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - DAGSTER_CURRENT_IMAGE=receipt-dagster-webserver
    volumes:
      - .:/app
      - dagster_home:/app/dagster_home
      - signal_cli_data:/root/.local/share/signal-cli
    command: ["dagster", "dev", "-h", "0.0.0.0", "-p", "3000"]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network
    labels:
      # Accessible via dagster.home.tailc6fb0e.ts.net
      - "traefik.enable=true"
      - "traefik.http.routers.dagster.rule=Host(`dagster.home.tailc6fb0e.ts.net`)"
      - "traefik.http.routers.dagster.entrypoints=web"
      - "traefik.http.services.dagster.loadbalancer.server.port=3000"

  # ============================================
  # STREAMLIT - Dashboard technique
  # ============================================
  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: receipt-dashboard
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./dashboard:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network
    labels:
      # Accessible via streamlit.home.tailc6fb0e.ts.net
      - "traefik.enable=true"
      - "traefik.http.routers.streamlit.rule=Host(`streamlit.home.tailc6fb0e.ts.net`)"
      - "traefik.http.routers.streamlit.entrypoints=web"
      - "traefik.http.services.streamlit.loadbalancer.server.port=8501"

  # ============================================
  # METABASE - Dashboard utilisateur
  # ============================================
  metabase:
    image: metabase/metabase:latest
    container_name: receipt-metabase
    restart: unless-stopped
    environment:
      # Metabase utilise PostgreSQL pour stocker sa config
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: ${POSTGRES_USER}
      MB_DB_PASS: ${POSTGRES_PASSWORD}
      MB_DB_HOST: postgres
    ports:
    - "3001:3000" 
    volumes:
      - metabase_data:/metabase-data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - receipt-network
    labels:
      # Accessible via metabase.home.tailc6fb0e.ts.net
      - "traefik.enable=true"
      - "traefik.http.routers.metabase.rule=Host(`metabase.home.tailc6fb0e.ts.net`)"
      - "traefik.http.routers.metabase.entrypoints=web"
      - "traefik.http.services.metabase.loadbalancer.server.port=3000"

# ============================================
# VOLUMES
# ============================================
volumes:
  receipt_pgdata:
    driver: local
  pgadmin_data:
    driver: local
  dagster_home:
    driver: local
  signal_cli_data:
    driver: local
  metabase_data:
    driver: local
  traefik_certs:
    driver: local

# ============================================
# NETWORKS
# ============================================
networks:
  receipt-network:
    driver: bridge